name: Deploy Django App to Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Step 1: Checkout code
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Step 2: Prepare Django package
      # -----------------------------
      - name: Prepare Django package
        run: |
          rm -rf deploy
          mkdir deploy

          # Copy backend project
          cp -r backend/* deploy/

          # Create Procfile for Django (production-safe)
          echo "web: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3 --timeout 120 --log-level info" > deploy/Procfile

          # Ensure requirements.txt exists
          if [ ! -f deploy/requirements.txt ]; then
            touch deploy/requirements.txt
          fi

          # Ensure required packages exist (no duplicates)
          grep -q "^Django" deploy/requirements.txt || echo "Django>=4.2" >> deploy/requirements.txt
          grep -q "^gunicorn" deploy/requirements.txt || echo "gunicorn==21.2.0" >> deploy/requirements.txt
          grep -q "^psycopg2-binary" deploy/requirements.txt || echo "psycopg2-binary" >> deploy/requirements.txt
          grep -q "^python-dotenv" deploy/requirements.txt || echo "python-dotenv" >> deploy/requirements.txt
          grep -q "^djangorestframework" deploy/requirements.txt || echo "djangorestframework" >> deploy/requirements.txt
          grep -q "^drf-spectacular" deploy/requirements.txt || echo "drf-spectacular" >> deploy/requirements.txt

      # -----------------------------
      # Step 3: Zip application
      # -----------------------------
      - name: Zip application
        run: |
          cd deploy
          zip -r ../app.zip .
          cd ..

      # -----------------------------
      # Step 4: Deploy to Elastic Beanstalk
      # -----------------------------
      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          application_name: Novya-ebk-env
          environment_name: Novya-ebk-env-django
          region: us-east-1

          version_label: v-${{ github.run_number }}-${{ github.run_id }}
          deployment_package: app.zip

          wait_for_deployment: false
          use_existing_version_if_available: false
